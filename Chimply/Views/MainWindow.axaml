<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Chimply.ViewModels"
        xmlns:models="using:Chimply.Models"
        xmlns:converters="using:Chimply.Converters"
        x:Class="Chimply.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Chimply - Network Scanner"
        Icon="/Resource/icon.png"
        Width="1000" Height="600"
        MinWidth="800" MinHeight="400">

    <Window.Resources>
        <converters:StatusToBrushConverter x:Key="StatusToBrush" />
        <converters:StringToBrushConverter x:Key="StringToBrush" />
    </Window.Resources>

    <DockPanel Margin="10">
        <!-- Top bar: Subnet input + buttons -->
        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="8" Margin="0,0,0,8">
            <TextBlock Text="Subnet:" VerticalAlignment="Center" />
            <TextBox Text="{Binding SubnetInput}"
                     Watermark="e.g. 192.168.1.0/24"
                     Width="250"
                     VerticalAlignment="Center" />
            <Button Content="Scan"
                    Command="{Binding ScanCommand}"
                    HotKey="Enter"
                    VerticalAlignment="Center" />
            <Button Content="Stop"
                    Command="{Binding StopCommand}"
                    VerticalAlignment="Center" />
            <Button Content="Clear"
                    Command="{Binding ClearCommand}"
                    VerticalAlignment="Center" />
            <Button Content="Export CSV"
                    Click="OnExportCsvClick"
                    VerticalAlignment="Center" />
            <Border Width="1" Background="#555555" Margin="4,2" />
            <Button Content="Config"
                    Click="OnConfigClick"
                    VerticalAlignment="Center" />
            <Button Content="About"
                    Click="OnAboutClick"
                    VerticalAlignment="Center" />
        </StackPanel>

        <!-- Progress bar -->
        <ProgressBar DockPanel.Dock="Top"
                     Value="{Binding Progress}"
                     Maximum="{Binding ProgressMax}"
                     IsVisible="{Binding IsScanning}"
                     Height="4"
                     Margin="0,0,0,8" />

        <!-- Bottom bar: status text + hosts found -->
        <DockPanel DockPanel.Dock="Bottom" Margin="0,8,0,0">
            <TextBlock Text="{Binding StatusText}" VerticalAlignment="Center" />
            <TextBlock Text="{Binding HostsFound, StringFormat='Hosts found: {0}'}"
                       HorizontalAlignment="Right"
                       VerticalAlignment="Center" />
        </DockPanel>

        <!-- Center: DataGrid -->
        <DataGrid ItemsSource="{Binding Results}"
                  IsReadOnly="True"
                  CanUserResizeColumns="True"
                  CanUserSortColumns="True"
                  CanUserReorderColumns="True"
                  GridLinesVisibility="Horizontal"
                  BorderThickness="1"
                  BorderBrush="#333333"
                  AutoGenerateColumns="False">
            <DataGrid.Columns>
                <DataGridTextColumn Header="IP Address"
                                    Binding="{Binding IpAddress}"
                                    CustomSortComparer="{x:Static converters:IpAddressComparer.Instance}"
                                    Width="150" />
                <DataGridTextColumn Header="Hostname"
                                    Binding="{Binding Hostname}"
                                    Width="200" />
                <DataGridTextColumn Header="RTT (ms)"
                                    Binding="{Binding RoundTripTime}"
                                    Width="80" />
                <DataGridTextColumn Header="MAC Address"
                                    Binding="{Binding MacAddress}"
                                    Width="150" />
                <DataGridTextColumn Header="Manufacturer"
                                    Binding="{Binding Manufacturer}"
                                    Width="130" />
                <DataGridTemplateColumn Header="Open Ports" SortMemberPath="OpenPorts.Count" Width="150">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate x:DataType="models:ScanResult">
                            <ItemsControl ItemsSource="{Binding PortEntries}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal" Spacing="4" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="models:PortEntry">
                                        <Button Content="{Binding Port}"
                                                Command="{Binding OpenCommand}"
                                                Padding="6,2"
                                                MinWidth="0"
                                                FontSize="11"
                                                Background="Transparent"
                                                Foreground="#64B5F6"
                                                BorderThickness="0"
                                                Cursor="Hand" />
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTemplateColumn Header="First Seen" SortMemberPath="StatusChangedAt" Width="130">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate x:DataType="models:ScanResult">
                            <TextBlock Text="{Binding TimeSinceDiscovery}"
                                       Foreground="{Binding TimeSinceColor, Converter={StaticResource StringToBrush}}"
                                       VerticalAlignment="Center"
                                       Margin="4,0" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTemplateColumn Header="Status" SortMemberPath="Status" Width="80">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Status}"
                                       Foreground="{Binding Status, Converter={StaticResource StatusToBrush}}"
                                       VerticalAlignment="Center"
                                       Margin="4,0" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>
    </DockPanel>
</Window>
